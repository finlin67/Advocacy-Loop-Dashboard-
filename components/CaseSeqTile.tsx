'use client';

import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Smile, Share2, UserPlus, RefreshCw, Zap } from 'lucide-react';

/**
 * CaseSeqTile
 * 
 * A high-performance advocacy loop visualization component.
 * Optimized for Framer Motion v12+ and strict gallery constraints.
 */

const loopSteps = [
  {
    id: 1,
    title: "Happy Customer",
    desc: "Peak satisfaction trigger",
    icon: Smile,
    color: "#13a4ec",
    position: "top"
  },
  {
    id: 2,
    title: "Share Referral",
    desc: "Incentivized sharing",
    icon: Share2,
    color: "#a855f7",
    position: "right"
  },
  {
    id: 3,
    title: "New Lead Gen",
    desc: "High-trust organic growth",
    icon: UserPlus,
    color: "#d946ef",
    position: "bottom"
  },
  {
    id: 4,
    title: "Awareness Loop",
    desc: "Higher conversion intent",
    icon: RefreshCw,
    color: "#22d3ee",
    position: "left"
  }
];

export default function CaseSeqTile() {
  const [activeStep, setActiveStep] = useState(0);

  useEffect(() => {
    const timer = setInterval(() => {
      setActiveStep((prev) => (prev + 1) % loopSteps.length);
    }, 3000);
    return () => clearInterval(timer);
  }, []);

  return (
    <div className="w-full aspect-square max-w-[600px] flex items-center justify-center p-4 relative bg-[#111c22] border border-[#325567] rounded-xl overflow-hidden shadow-2xl isolate">
      
      {/* Background Gradients/Glows */}
      <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-[#13a4ec]/10 via-transparent to-transparent opacity-[0.5]" />
      <div className="absolute top-0 right-0 w-64 h-64 bg-purple-500/10 blur-[100px] rounded-full" />
      <div className="absolute bottom-0 left-0 w-64 h-64 bg-[#13a4ec]/10 blur-[100px] rounded-full" />

      {/* Central Hub (Engine) */}
      <div className="absolute z-10 flex flex-col items-center justify-center">
        <div className="relative flex items-center justify-center">
          {/* Outer Spinning Ring */}
          <motion.div 
            animate={{ rotate: [0, 360] }}
            transition={{ duration: 20, repeat: Infinity }}
            className="absolute inset-[-12px] rounded-full border border-dashed border-[#325567]/50 w-32 h-32"
          />
          {/* Inner Counter-Spinning Ring */}
          <motion.div 
            animate={{ rotate: [0, -360] }}
            transition={{ duration: 15, repeat: Infinity }}
            className="absolute inset-[-4px] rounded-full border border-dotted border-[#13a4ec]/30 w-28 h-28"
          />
          
          {/* Core Hub */}
          <div className="relative w-24 h-24 bg-[#1a2c38] rounded-full border border-[#325567] flex items-center justify-center shadow-[0_0_30px_rgba(19,164,236,0.15)] overflow-hidden">
            <motion.div
              animate={{ scale: [1, 1.15, 1], opacity: [0.1, 0.2, 0.1] }}
              transition={{ duration: 2, repeat: Infinity, repeatType: "mirror" as const }}
              className="absolute inset-0 bg-[#13a4ec] rounded-full"
            />
            <Zap className="w-8 h-8 text-[#13a4ec] fill-[#13a4ec]/20 z-10" />
          </div>
        </div>
        <div className="mt-4 text-center">
          <p className="text-white font-bold text-sm tracking-widest uppercase">Growth</p>
          <p className="text-[#92b7c9] text-[10px] font-medium opacity-80 uppercase tracking-tighter">Engine Active</p>
        </div>
      </div>

      {/* Connecting Lines (The Loop Visualizer) */}
      <svg className="absolute inset-0 w-full h-full pointer-events-none z-0 overflow-visible" viewBox="0 0 600 600">
        <defs>
          <linearGradient id="lineGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="#13a4ec" stopOpacity="0.2" />
            <stop offset="50%" stopColor="#a855f7" stopOpacity="0.2" />
            <stop offset="100%" stopColor="#13a4ec" stopOpacity="0.2" />
          </linearGradient>
        </defs>
        
        {/* Main Circular Path */}
        <motion.circle 
          cx="300" cy="300" r="210"
          fill="none"
          stroke="url(#lineGradient)"
          strokeWidth="1.5"
          strokeDasharray="12 12"
          animate={{ rotate: [0, 360] }}
          transition={{ duration: 60, repeat: Infinity }}
          style={{ transformOrigin: "300px 300px" }}
        />

        {/* Orbiting Particles */}
        <motion.g 
          animate={{ rotate: [0, 360] }}
          transition={{ duration: 12, repeat: Infinity }}
          style={{ transformOrigin: "300px 300px" }}
        >
          <circle cx="300" cy="90" r="4" fill="#13a4ec" className="shadow-[0_0_15px_#13a4ec]" />
          <motion.circle 
            cx="300" cy="90" r="8" 
            stroke="#13a4ec" 
            strokeWidth="1" 
            fill="none" 
            animate={{ scale: [1, 2], opacity: [0.5, 0] }}
            transition={{ duration: 1.5, repeat: Infinity }}
          />
        </motion.g>

        <motion.g 
          animate={{ rotate: [180, 540] }}
          transition={{ duration: 16, repeat: Infinity }}
          style={{ transformOrigin: "300px 300px" }}
        >
          <circle cx="300" cy="90" r="3" fill="#a855f7" className="shadow-[0_0_10px_#a855f7]" />
        </motion.g>
      </svg>

      {/* Loop Nodes */}
      {loopSteps.map((step, index) => {
        const isActive = activeStep === index;
        
        let positionClasses = "";
        if (step.position === 'top') positionClasses = "top-[10%] left-1/2 -translate-x-1/2";
        if (step.position === 'bottom') positionClasses = "bottom-[10%] left-1/2 -translate-x-1/2";
        if (step.position === 'left') positionClasses = "left-[10%] top-1/2 -translate-y-1/2";
        if (step.position === 'right') positionClasses = "right-[10%] top-1/2 -translate-y-1/2";

        const Icon = step.icon;

        return (
          <motion.div
            key={step.id}
            className={`absolute ${positionClasses} flex flex-col items-center gap-2 z-20 w-32`}
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ delay: index * 0.1 }}
          >
            <div className="relative group cursor-pointer">
              {/* Active Ping */}
              <AnimatePresence>
                {isActive && (
                  <motion.span 
                    initial={{ opacity: 0, scale: 0.8 }}
                    animate={{ opacity: [0, 0.5, 0], scale: [1, 1.4] }}
                    exit={{ opacity: 0 }}
                    transition={{ duration: 2, repeat: Infinity }}
                    className="absolute inset-0 rounded-2xl" 
                    style={{ backgroundColor: step.color }}
                  />
                )}
              </AnimatePresence>
              
              {/* Icon Container */}
              <motion.div 
                className={`relative flex items-center justify-center w-14 h-14 rounded-2xl border bg-[#111c22] overflow-hidden`}
                animate={{ 
                  borderColor: isActive ? step.color : '#325567',
                  boxShadow: isActive ? [`0 0 0px ${step.color}00`, `0 0 15px ${step.color}44`, `0 0 0px ${step.color}00`] : 'none'
                }}
                transition={{ duration: 2, repeat: Infinity }}
              >
                {/* Subtle Pulse/Glow Icon Animation */}
                <motion.div
                  className="z-10 flex items-center justify-center"
                  animate={isActive ? { 
                    scale: [1, 1.2, 1],
                    filter: [
                      `drop-shadow(0 0 0px ${step.color}00)`,
                      `drop-shadow(0 0 8px ${step.color}88)`,
                      `drop-shadow(0 0 0px ${step.color}00)`
                    ]
                  } : { scale: 1, filter: "none" }}
                  transition={{ duration: 2, repeat: Infinity }}
                >
                  <Icon 
                    size={24} 
                    color={isActive ? step.color : "#92b7c9"} 
                  />
                </motion.div>
                
                {/* Progress Border Effect */}
                {isActive && (
                  <motion.div 
                    initial={{ height: 0 }}
                    animate={{ height: "100%" }}
                    transition={{ duration: 3 }}
                    className="absolute bottom-0 left-0 w-1 opacity-60"
                    style={{ backgroundColor: step.color }}
                  />
                )}
              </motion.div>
            </div>

            {/* Labels */}
            <div className="text-center">
              <motion.h3 
                animate={{ color: isActive ? "#ffffff" : "#92b7c9" }}
                className="text-[11px] font-bold uppercase tracking-wider mb-0.5"
              >
                {step.title}
              </motion.h3>
              <AnimatePresence mode="wait">
                {isActive && (
                  <motion.p 
                    initial={{ opacity: 0, y: 5 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, y: -5 }}
                    className="text-[#92b7c9] text-[9px] font-medium leading-tight max-w-[100px] mx-auto"
                  >
                    {step.desc}
                  </motion.p>
                )}
              </AnimatePresence>
            </div>
          </motion.div>
        );
      })}

      {/* Dynamic Growth Pills */}
      <motion.div 
          className="absolute top-[22%] right-[22%] bg-[#1a2c38]/90 backdrop-blur-md border border-[#0bda57]/30 px-2.5 py-1 rounded-full pointer-events-none z-30"
          animate={{ y: [0, -4, 0], opacity: [0.8, 1, 0.8] }}
          transition={{ duration: 4, repeat: Infinity }}
      >
          <p className="text-[#0bda57] text-[10px] font-black tracking-tight">+35% Leads</p>
      </motion.div>

      <motion.div 
          className="absolute bottom-[22%] left-[22%] bg-[#1a2c38]/90 backdrop-blur-md border border-[#a855f7]/30 px-2.5 py-1 rounded-full pointer-events-none z-30"
          animate={{ y: [0, 4, 0], opacity: [0.8, 1, 0.8] }}
          transition={{ duration: 5, repeat: Infinity }}
      >
          <p className="text-[#a855f7] text-[10px] font-black tracking-tight">-18% CAC</p>
      </motion.div>

    </div>
  );
}
